# motion_capture

<div align="center">
    <img src="_github/img01.png" height="300">
    <img src="_github/img02.png" height="300">
    <img src="_github/img03.png" height="300">
</div>

## 使用方法

1. http://52.195.205.99 にアクセスします。
2. ブラウザに動画をアップロードします。
   - [_sample_videos](_sample_videos/) の動画をお使いください。
3. リアルタイムに姿勢推定の結果を表示するには「バウンディングボックスを表示」をクリックしてください。
4. CSV形式のモーションデータをダウンロードするには「モーションをダウンロード」をクリックしてください。

## 概要

このアプリケーションでは、ユーザーはブラウザを通じて動画をアップロードします。その後、サーバーサイドで動画を処理し、姿勢推定を行います。推定結果は、動画にバウンディングボックスやポイントを描画する形で再生されるか、または各関節の座標がCSV形式で保存され、クライアントに提供されます。

## 経緯

私が大学3年生前期の頃、他大学と共同で開発を行うPBL形式の授業で、メタバース空間で演奏セッションができるスマートフォンアプリを作ることになりました。そこで私は、スマートフォンのカメラから動画を撮影し、その動画を基に画像処理を行い、3Dモデルを動かすためのモーションをキャプチャする機能を担当しました。

このプロジェクトでは、主に3DCGを使うため、開発環境としてUnityを使うことを決めました。しかし、画像処理については、大学で学んだ内容やインターネットにある情報の殆どはPythonのプログラムであったため、Unityでそのまま実行することはできませんでした。そこで、画像処理をC#で短期間で実装するのは難しいと判断し、APIを介してPythonプログラムを実行し、画像処理ができるようにしようと考えました。このリポジトリは、そのモーションキャプチャを行うAPIをブラウザから操作出来るようにしたものです。

## VRMについて

Unityで3Dモデルを動かす際、3Dモデルの形式として、PMXとVRMの2つの選択肢がありました。

PMXは、MikuMikuDance（MMD）という3Dアニメーションソフトウェア向けのファイルフォーマットです。MMDコミュニティでは、このフォーマットを使用して3Dキャラクターモデルを作成し、アニメーション化し、共有するために使われます。PMXファイルにはモデルのメッシュ、テクスチャ、ボーンの情報、表情などが含まれています。主にMMD動画などのコンテンツ制作に使用されます。

VRMは、3D仮想キャラクターモデルを表すファイルフォーマットおよび仕様です。VRMフォーマットは、バーチャル現実（VR）ゲーム、バーチャルYouTuber、仮想アイドル、仮想世界、コンテンツ制作、交流プラットフォームなどで広く使用されています。VRMファイルには、3Dモデルのメッシュ、テクスチャ、骨の情報、表情データなどが含まれており、ユーザーはこれらの3Dキャラクターをさまざまな仮想環境で使用できます。VRMは、オープンで拡張可能なフォーマットであり、多くのアプリケーションやプラットフォームでサポートされています。

今回、上記の2つからはVRMを選択しました。理由としては、PMXが「MMDを製作するためのファイルフォーマット」であり、VRMが「VRアプリケーション向けの人型3Dアバターデータを扱うためのファイルフォーマット」だったからです。私はMMDに関して以前から知見があり、当初はPMXの方が導入し易いと考えていました。しかし、調べるとUnityではPMXの使用があまり適していないことが分かりました。そこで消去法から、UnityにおけるVRMの利用方法を調べました。その結果、VRMがVRアプリケーション（メタバースに近似）を想定していることや、多くのアプリケーションやプラットフォームでサポートしていることから、私たちが取り組んでいるプロジェクトの方針と合っていると考えました。

また、3Dモデルの形式として、FBXも候補にありましたが、モデルの外観の選択肢の豊富さからPMXとVRMを主な候補として考えました。今になって考えるとFBXも調べれば良かったかもしれないです。

## 課題

- 「モーションをダウンロード」をクリックしないと、アップロードした動画が削除されず、サーバ側に残ってしまう。
- PythonプログラムとしてAPIでの実装ではなく、C#プログラムとしてUnityでの実装をする。
- モーションキャプチャの出力がVRMに適していない。
    - VRMとモーションキャプチャの出力のボーンの数と位置が合っていない。
        - 下の左図はVRMのボーン、右図はモーションキャプチャの出力。
        - 画像認識に外部のライブラリを利用したため、出力がVRMに適していない。
    - 体の向きが分かりづらい。
        - 出力が棒人間形状であるため、腕や脚などの向きが分かりづらい。
        - 腕であれば、肩、肘、手首の3点の座標が分かれば向きを推測できるが、それらが一直線上に並んだ時に推測ができない。
    - 座標じゃなくて回転角度が欲しい。
        - やはりVRMを動かす上では、モーションデータは座標ではなく、それぞれの関節の回転角度の値の方が扱いやすい。
<div align="center">
    <img src="_github/img04.png" height="200">
    <img src="_github/img05.png" height="200">
</div>
